/* Meiya 2016-05-26 10:47 */!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d=a("../../public/src/ui/zepto.loading"),e=a("./tpl/template.js"),f=new d,g=MY.appBridge,h=($(".container"),$("#J_Tools")),i={id:0,getID:function(){var a=$.Deferred();if(MY.isApp)g.callHandler("get_query_string",function(b){var c=b.query_string;c.match(/id=(\d+)/),i.id=RegExp.$1||null,a.resolve(i.id)});else{var b=window.location.href;b.match(/id=(\d+)/),i.id=RegExp.$1||null,a.resolve(i.id)}return a.promise()},init:function(){var a=this;this.getID().done(function(){MY.isApp?a.user.init():a.tools.render()})},user:{id:0,token:"",getUserID:function(){var a=this,b=$.Deferred();return g.callHandler("get_user_id",function(c){a.id=c.user_id?+c.user_id:0,b.resolve(a.id)}),b.promise()},getLoginToken:function(){var a=this,b=$.Deferred();return g.callHandler("get_login_token",function(c){a.token=c.token?c.token:"",b.resolve(a.token)}),b.promise()},init:function(){this.getUserID().done(function(){i.tools.render()})}},tools:{url:"",load:function(){var a=$.Deferred();return MY.xhr.api({url:"/v1/qiniu-up-tokens/web",type:"get",success:function(b){a.resolve(b.data)}}),a.promise()},render:function(){var a=this;this.load().done(function(b){var c=new Date,d=c.getFullYear()+"/"+(c.getMonth()+1)+"/"+c.getDate(),g=Math.random().toString().replace("0.",""),j=[d,"/",i.user.id,g,".png"].join("");h.html(e("tools",{token:b.token,key:j})),f.hide(),a.event()})},event:function(){var a=h.find(".file"),b=h.find(".btn-submit"),c=($("#J_Form"),$("#J_ImageForm")),d=this;a.on("change",function(){var a=$(this),b=a.val(),e=b.split(".")[b.split(".").length-1];return/(jpg|png|gif|jpeg|bmp)/.test(e)?void MY.xhr.ajax({url:"http://upload.qiniu.com/",type:"post",data:new FormData(c[0]),processData:!1,contentType:!1}).done(function(a){if(a.key){var b="http://"+a.bucket+".qiniudn.com/"+a.key,c=['<div class="images">','<img src="',b,'?imageView2/2/w/120">',"</div>"].join(""),e=$(c);d.url?(h.find(".images").remove(),h.append(e)):h.append(e),d.url=b,d.images=[{height:a.height,width:a.width,url:d.url}],g.callHandler("my_toast",{delay:1.5,content:"图片上传成功！"})}}).fail(function(a){g.callHandler("my_toast",{delay:1.5,content:"图片上传失败！请稍候再试"})}):void g.callHandler("my_toast",{delay:1.5,content:"只能上传图片文件"})}),b.on("click",function(){var a=$(".form-content"),b=a.val(),c=d.images||[];(b||c.length)&&MY.xhr.ajax({url:"/api/feedback-replies",type:"post",data:{user_id:i.user.id,feedback_id:i.id,content:b,images:c},success:function(a){return-200==a.code?void g.callHandler("my_toast",{delay:1.5,content:a.message||"回复失败，请重试"}):(g.callHandler("my_toast",{delay:1.5,content:"回复成功"}),void setTimeout(function(){window.history.go(-1)},1500))}})})}}};i.init()},{"../../public/src/ui/zepto.loading":3,"./tpl/template.js":2}],2:[function(a,b,c){!function(){function a(a,b){return(/string|function/.test(typeof b)?j:i)(a,b)}function d(a,b){return"string"!=typeof a&&(b=typeof a,"number"===b?a+="":a="function"===b?d(a.call(a)):""),a}function e(a){return n[a]}function f(a){return d(a).replace(/&(?![\w#]+;)|[<>"']/g,e)}function g(a,b){if(o(a))for(var c=0,d=a.length;d>c;c++)b.call(a,a[c],c,a);else for(c in a)b.call(a,a[c],c)}function h(a,b){var c=/(\/)[^\/]+\1\.\.\1/,d=("./"+a).replace(/[^\/]+$/,""),e=d+b;for(e=e.replace(/\/\.\//g,"/");e.match(c);)e=e.replace(c,"/");return e}function i(b,c){var d=a.get(b)||k({filename:b,name:"Render Error",message:"Template not found"});return c?d(c):d}function j(a,b){if("string"==typeof b){var c=b;b=function(){return new m(c)}}var d=l[a]=function(c){try{return new b(c,a)+""}catch(d){return k(d)()}};return d.prototype=b.prototype=p,d.toString=function(){return b+""},d}function k(a){var b="{Template Error}",c=a.stack||"";if(c)c=c.split("\n").slice(0,2).join("\n");else for(var d in a)c+="<"+d+">\n"+a[d]+"\n\n";return function(){return"object"==typeof console&&console.error(b+"\n\n"+c),b}}var l=a.cache={},m=this.String,n={"<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","&":"&#38;"},o=Array.isArray||function(a){return"[object Array]"==={}.toString.call(a)},p=a.utils={$helpers:{},$include:function(a,b,c){return a=h(c,a),i(a,b)},$string:d,$escape:f,$each:g},q=a.helpers=p.$helpers;a.get=function(a){return l[a.replace(/^\.\//,"")]},a.helper=function(a,b){q[a]=b},"function"==typeof define?define(function(){return a}):"undefined"!=typeof c?b.exports=a:this.template=a,a("list",function(a){"use strict";var b=this,c=b.$helpers,d=a.data,e=b.$escape,f=b.$each,g=(a.image,a.$index,a.item,a.i,"");return g+='<li class="comment"> <div class="author"> <div class="avator"> ',d.user&&d.user.avatar_url?(g+=' <img src="',g+=e(d.user.avatar_url),g+='?imageView2/1/w/160" alt=""> '):g+=' <img src="http://st0.meiyaapp.com/app/default_avatar.jpg" alt=""> ',g+=' </div> <div class="userinfo"> <p class="username">',g+=e(d.username),g+='</p> <p class="time">',g+=e(c.dateFormat(1e3*d.created_time,"yyyy-MM-dd hh:mm")),g+='</p> </div> </div> <div class="content"> <p>',g+=e(d.content),g+="</p> ",d.images&&d.images.length&&(g+=' <p class="pics"> ',f(d.images,function(a){g+=' <img src="',g+=e(a.url),g+='?imageView2/2/w/200"> '}),g+=" </p> "),g+=" </div> </li> ",f(d.feedback_reply,function(a){g+=' <li class="comment"> <div class="author"> <div class="avator"> ',a.user&&a.user.avatar_url?(g+=' <img src="',g+=e(a.user.avatar_url),g+='?imageView2/1/w/160" alt=""> '):g+=' <img src="http://st0.meiyaapp.com/app/default_avatar.jpg" alt=""> ',g+=' </div> <div class="userinfo"> <p class="username">',g+=e(a.user.username),g+='</p> <p class="time">',g+=e(c.dateFormat(1e3*a.created_time,"yyyy-MM-dd hh:mm")),g+='</p> </div> </div> <div class="content"> <p>',g+=e(a.content),g+="</p> ",a.images&&a.images.length&&(g+=' <p class="pics"> ',f(a.images,function(a){g+=' <img src="',g+=e(a.url),g+='?imageView2/2/w/200"> '}),g+=" </p> "),g+=" </div> </li> "}),new m(g)}),a("tools",function(a){"use strict";var b=this,c=(b.$helpers,b.$escape),d=a.token,e=a.key,f="";return f+='<form method="post" action="http://upload.qiniu.com/" enctype="multipart/form-data" class="img" id=\'J_ImageForm\'> <div class="field"> <input name="token" type="hidden" value="',f+=c(d),f+='"> <input name="key" type="hidden" value="',f+=c(e),f+='"> <input name="file" type="file" class="file" id=\'J_File\'> <a href="javascript:void(0);" class="btn btn-image">图片</a> </div> <div class="field"> <a href="javascript:void(0);" class="btn btn-submit">发布</a> </div> </form>',new m(f)})}()},{}],3:[function(a,b,c){var d={elem:".J_Loading",onshow:function(){},onhide:function(){}},e='<div class="J_Loading loading"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>',f=function(a){var b=null;a=$.extend(d,a||{}),$.extend(this,a),b=$(a.elem),0===b.length&&(b=$(e),document.body.appendChild(b[0])),this.$elem=b},g=f.prototype={constructor:f};$.extend(g,{show:function(){return this.$elem.show(),this.__dispatchEvent("show"),this},hide:function(){return this.$elem.hide(),this.__dispatchEvent("hide"),this},__dispatchEvent:function(a,b){this["on"+a]&&this["on"+a](b)},destory:function(){this.$elem.remove();for(var a in this)delete this[a];return this}}),b.exports=f},{}]},{},[1]);