/* Meiya 2016-05-30 16:26 */!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d=(MY.appBridge,MY.xhr),e={};e.user={id:0,data:null,getID:function(){var a=this,b=$.Deferred();return MY.appBridge.callHandler("get_user_id",function(c){a.id=c.user_id?+c.user_id:0,b.resolve(a.id)}),b.promise()},getData:function(a,b){var c=this;a=a||this.id;var e={url:"/v1/users/"+a,type:"get",success:function(a){c.data=a.data}};return"object"==typeof b&&(e.data=b),d.api(e)}},e.mission={data:null,getData:function(a,b){var c=this;return b=b||1,d.api({url:"/v1/mission",type:"get",data:{user_id:a,type:b},success:function(a){c.data=a.data}})}},b.exports=e},{}],2:[function(a,b,c){"use strict";var d=function(){},e=function(a,b){if(a){var c=this;if("object"==typeof b)for(var d in b)this[d]=b[d];var e=a.dataset,f=e.countdown_format;e.countdown_handler||(e.countdown_handler=setInterval(function(){var b=Number(e.countdown_time),d=Number(e.countdown_limit);if(isNaN(b)||0>=b)return clearInterval(e.countdown_handler),delete e.countdown_handler,void(0>=b&&c.onEnd(a));if(e.countdown_time=--b,d){if(b>=d)return;c.onLimit(a),delete e.countdown_limit}a.innerHTML=c.timeFormat(e.countdown_time,f)},1e3))}};e.prototype={constructor:e,onLimit:d,onEnd:d,timeFormat:function(a,b){b=b||"";var c=function(a){return a>0?(9>=a&&(a="0"+a),String(a)):"00"},d={s:"00",m:"00",h:"00",d:"00",M:"00",y:"0"};return a>0&&(d.s=c(a%60),d.m=Math.floor(a/60)>0?c(Math.floor(a/60)%60):"00",d.h=Math.floor(a/3600)>0?c(Math.floor(a/3600)%24):"00",d.d=Math.floor(a/86400)>0?c(Math.floor(a/86400)%30):"00",d.M=Math.floor(a/2629744)>0?c(Math.floor(a/2629744)%12):"00",d.y=Math.floor(a/31556926)>0?Math.floor(a/31556926):"0"),""===b&&(b="00"!=d.d?"dd天hh小时":"hh小时mm分ss秒"),b=b.replace(/([yMdhms])+/g,function(a,b){var c=d[b];return void 0!==c?(a.length>1&&(c="0"+c,c=c.substr(c.length-2)),c):void 0})}},b.exports=e},{}],3:[function(a,b,c){"use strict";var d=MY,e=d.appBridge,f=d.xhr,g=a("./tpl/template"),h=a("./tpl/prize/content"),i=a("./common/common"),j=a("./common/countdown"),k=a("../../public/src/ui/zepto.toast"),l=a("../../public/src/ui/zepto.loading"),m=new l,n={};n.user=i.user,g.helper("dateFormat",MY.dateFormat),g.helper("timeFormat",function(a,b){b=b||"";var c=Math.floor((+new Date-a)/1e3),d={};return c>0&&(d.s=c%60,d.m=Math.floor(c/60)>0?Math.floor(c/60%60):0,d.h=Math.floor(c/3600)>0?Math.floor(c/3600%24):0,d.d=Math.floor(c/86400)>0?Math.floor(c/86400%30):0),""===b&&(d.d?b=MY.dateFormat(a,"MM月dd日"):d.h?b=d.h+"小时前":d.m?b=d.m+"分钟前":d.s&&(b=d.s+"秒前")),b}),g.helper("nameHide",function(a,b){return b=a.replace(a.substr(1),b+a.substr(-1))}),n.user.local=function(a){var b=this,c=$.Deferred();return localStorage.getItem("points_user")&&"undefined"!=localStorage.getItem("points_user")?(this.data=JSON.parse(localStorage.getItem("points_user")),c.resolve(this.data),this.getData().done(function(a){localStorage.setItem("points_user",JSON.stringify(b.data)),c.resolve(b.data)})):this.getData().done(function(a){localStorage.setItem("points_user",JSON.stringify(b.data)),c.resolve(b.data)}),c.promise()};var o=function(a){var b="http://st0.meiyaapp.com/act/public/img/logo-80X80.png",c=MY.locationOrigin+"/web_v2/gw.php?name=points&view=prize&id="+a;e.registerHandler("call_share_channel_action",function(){var a=n.prize.res.data,d="美芽可以【免费兑换】【"+a.title+"】啦",f=d+" O(∩_∩)O~";e.callHandler("share_channel_action",{default_share:{title:d,content:d,url:c,image_url:a.images[0]?a.images[0].url:b},weibo:{title:f,content:f,url:c,image_url:a.images[0]?a.images[0].url:b}})})};n.prize={res:null,id:"",getData:function(a){a=a||this.id;var b=$.Deferred(),c=this;return this.res?b.resolve(this.res):f.api({url:"/v1/prize/"+a,type:"get",success:function(a){c.res=a,c.prizeLogs=[],a.data&&a.data.prizeLogsAll&&a.data.prizeLogsAll.length&&(c.prizeLogs=a.data.prizeLogsAll),b.resolve(c.res)}}),b.promise()},skuPanel:{active:!1,$btn:null,$panel:null,$mask:null,show:function(){var a=this;this.$panel.addClass("active"),this.$mask.addClass("active"),this.$panel.on("touchstart.sku",function(a){a.stopPropagation()}),this.$mask.on("touchstart.sku",function(b){b.target!=a.$btn[0]&&a.hide()}),this.active=!this.active},hide:function(){this.$panel.removeClass("active"),this.$mask.removeClass("active"),this.$panel.off("touchstart.sku"),this.$mask.off("touchstart.sku"),this.active=!this.active},init:function(a){$.extend(this,a);var b=this,c=this.$btn,d=this.$panel,e=$("#J_SkuClose"),f=window.localStorage,g={},h=n.prize.id;f.getItem("skus")&&(g=JSON.parse(f.getItem("skus"))),e.on("click",function(){b.active?b.hide():b.show()}),g[h]&&(b.sku_category=g[h],c.html(g[h]),d.find('input[value="'+g[h]+'"]').attr("checked","checked")),c.length&&(c.on("click",function(){b.active?b.hide():b.show()}),d.on("change","input[type=radio]",function(){c.html(this.value),g[h]=b.sku_category=this.value,f.setItem("skus",JSON.stringify(g)),b.hide()}))}},render:function(){var a=this,b=$("#J_Container"),c=this.res.data;b.html(h({data:c,timestamp:this.res.timestamp,userData:n.user.data,prizeLogs:this.prizeLogs,aday:86400}));var d=$("#J_SkuPanel"),f=$("#J_SkuBtn"),g=$("#J_SkuMask"),i=b.find(".introduction");if(this.skuPanel.init({$btn:f,$panel:d,$mask:g}),b.find(".J_Webview").on("tap",function(){var a=this.dataset.page;a&&e.callHandler("navi_webview_action",a)}),i.delegate("a","click",function(b){b.preventDefault();var d=$(this),f=d.attr("href");a.postStats("points_link_click",c.id),f&&e.callHandler("navi_webview_action",f)}),c.show_prize_logs&&this.prizeLogs.length>5){var j=$("#J_PrizeLogs"),k=j.find(".scroll"),l=k.height()/2,m=this.prizeLogs.length,o="translateY(-"+l+"px)",p=function q(){k.animate({"-webkit-transform":o,transform:o},1e3*m,function(){var a=$(this);a.css({"-webkit-transform":"translateY(0)",transform:"translateY(0)"}),q()})};p()}},countdown:function(){var a=this;new j(document.getElementById("J_Countdown"),{onEnd:function(a){a.innerHTML=""}}),new j(document.querySelectorAll(".J_BtnCountdown")[0],{onEnd:function(b){$(b);a.changeBtnStatus("start",b)}})},postExchange:function(a){return f.api({url:"/v1/prize-logs",type:"post",data:a,timeout:5e3})},changeBtnStatus:function(a,b){switch(a){case"start":b.className="btn primary",b.innerHTML="立即兑换",b.dataset.status="start",this.exchange();break;case"end":b.innerHTML="兑换结束",b.className="btn",b.dataset.status="end"}},exchange:function(){var a=this;$("#J_Exchange").off("tap.exchange").on("tap.exchange",function(){var b=this,c=a.res.data,d=b.dataset,f=d.status,g=1e3*c.end_time<=(new Date).getTime();if("end"===f&&g){g&&a.changeBtnStatus("end",b);var h=new k({delay:1,content:"活动已结束"}).show()}else{if(a.postStats("point_click"),"exchanged"===f)return void a.successRender(c.prizeLogs[0].id);if(1==c.type&&!n.user.data.m_idol)return void e.callHandler("my_dialog",{message:"美妞，成为M-idol才可兑换哦",buttons:["取消","成为M-idol"]},function(a){"成为M-idol"===a&&e.callHandler("navi_webview_action","http://act.meiyaapp.com/gw.php?name=h5&view=20160505/index&disable_share=1")});if(n.user.data.point<c.point)return void e.callHandler("my_dialog",{message:"抱歉，你的积分还差一点点",buttons:["取消","去赚积分"]},function(a){"去赚积分"===a&&e.callHandler("navi_webview_action","points/rules.html?disable_share=1")});if("wait"!==f){var h=new k({loading:!0,content:"小芽正在为你努力抢礼品"}).show(),i={user_id:n.user.id,prize_id:c.id,quantity:1,sku_category:a.skuPanel.sku_category};a.postExchange(i).done(function(d,f){var g=d.metadata,i=g.exchange_status;if(i)a.successRender(g.prize_log_id),h.close().remove();else{if(c.use_blacklist)return void setTimeout(function(){h.close().remove(),e.callHandler("my_dialog",{message:g.reason,buttons:["关闭"]})},1e3);h.close().remove(),new k({delay:1,content:g.reason}).show(),g.quantity<=0&&a.changeBtnStatus("end",b)}}).fail(function(a,b){h.close().remove(),new k({delay:1,content:"timeout"===b?"兑换的小伙伴太多啦，再试试":"兑换失败，请重试"}).show()}).always(function(){})}else var h=new k({delay:1,content:"活动未开始"}).show()}})},successRender:function(a){var b="points/success.html?enable_refresh=1&disable_share=1#id="+a;e.callHandler("navi_webview_action",b)},postStats:function(a,b,c,d){if(console.log(a),a&&"string"==typeof a){var e={event:a,object_id:b||this.id};return c&&(e.type=c),d&&(e.value=d),MY.xhr.api({type:"post",url:"/v1/stats",data:e})}},init:function(){this.postStats("point_view_count"),this.render(),this.exchange(),this.countdown(),m.hide().destory()}},n.init=function(){var a=this;e.callHandler("get_query_string",function(b){var c=b.query_string;c.match(/id=(\d+)/);var d=a.prize.id=RegExp.$1;n.share=new o(d),a.user.getID().done(function(b){if("0"!=a.user.id)$.when(a.user.local(),a.prize.getData()).done(function(){a.prize.init()});else{e.callHandler("request_login");var c=setInterval(function(){MY.appBridge.callHandler("get_user_id",function(a){"0"!=a.user_id&&(n.init(),clearInterval(c))})},500)}})})},n.init(),b.exports=n},{"../../public/src/ui/zepto.loading":6,"../../public/src/ui/zepto.toast":7,"./common/common":1,"./common/countdown":2,"./tpl/prize/content":4,"./tpl/template":5}],4:[function(a,b,c){"use strict";var d=a("../template");b.exports=d("prize/content",function(a){var b=this,c=b.$helpers,d=a.data,e=b.$string,f=a.timestamp,g=a.aday,h=a.userData,i=a.prizeLogs,j=b.$each,k=(a.prize,a.i,a.n,a.g,a.sku,"");return k+='<header class="header"> <div class="cover"> <img ',d.images&&d.images[0]?(k+='src="',k+=e(d.images[0].url),k+='?imageView2/2/w/640"'):k+='src="./img/default.png"',k+='/> </div> <div class="info"> <h1 class="title">',k+=e(d.title),k+='</h1> <div class="content"> <p class="pink">',k+=e(d.point),k+='积分</p> <p class="quantity"> 限量',k+=e(d.total_quantity),k+="份 ",1===d.type&&d.end_time>=f&&d.start_time<=f&&d.quantity>0&&(k+="(仅剩",k+=e(d.quantity),k+="份)"),k+=" </p>  ",d.start_time-f>g&&(k+=' <p class="meta"><span class="time">',k+=e(c.dateFormat(1e3*d.start_time,"MM月dd日 hh:mm")),k+="</span></p> "),k+=" ",d.start_time-f<=g&&d.start_time-f>=0&&(k+=' <p class="meta"><span id="J_Countdown" class="time" data-countdown_time="',k+=e(d.start_time-f),k+='"></span></p> '),k+=' </div> </div> </header> <div class="main"> <div class="button"> ',d.prizeLogs.length?(k+=" ",d.prizeLogs&&d.prizeLogs[0].sku_category&&(k+=' <button class="sku disabled">',k+=e(d.prizeLogs[0].sku_category),k+="</button> "),k+=' <button id="J_Exchange" data-status="exchanged" class="btn green">兑换成功<span>查看</span></button> '):(k+=" ",d.start_time>f&&(k+=" ",d.sku_category&&(k+=' <button id="J_SkuBtn" class="sku">',k+=e(d.sku_name),k+="</button> "),k+=' <button id="J_Exchange" class="btn purple J_BtnCountdown" data-status="wait" data-countdown_time="',k+=e(d.start_time-f),k+='" data-countdown_limit="60" data-countdown_format="ssS">即将开始</button> '),k+=" ",d.end_time>=f&&d.start_time<=f&&d.quantity>0&&(k+=" ",d.sku_category&&(k+=' <button id="J_SkuBtn" class="sku">',k+=e(d.sku_name),k+="</button> "),k+=' <button id="J_Exchange" data-status="start" class="btn pink">立即兑换</button> '),k+=" ",(d.end_time<f||d.quantity<=0)&&(k+=' <button id="J_Exchange" data-status="end" class="btn">兑换结束</button> '),k+=" "),k+=" </div> ",1!=d.type||h.m_idol?h.point<d.point&&(k+=' <div class="tips J_Webview" data-page="points/rules.html?disable_share=1"> 你的积分还差',k+=e(d.point-h.point),k+="，看看如何获取积分吧 </div> "):k+=' <div class="tips J_Webview" data-page="http://act.meiyaapp.com/gw.php?name=h5&view=20160505/index&disable_share=1"> 你还不是M-idol哦，看看如何成为M-idol吧 </div> ',k+=" ",d.show_prize_logs&&i&&i.length&&(k+=' <div class="content"> <div class="title"><span>兑换成功的美妞</span></div> <div class="article',i.length>5&&(k+=" animation"),k+='" id=\'J_PrizeLogs\'> <div class="scroll"> ',j(i,function(a){k+=" ",a.user&&(k+=' <p><span class="name">',k+=e(c.nameHide(a.user.username,"**")),k+='</span><span class="time">',k+=e(c.timeFormat(1e3*a.created_time)),k+="</span></p> "),k+=" "}),k+=" ",i.length>5&&(k+=" ",j(i,function(a){k+=" ",a.user&&(k+=' <p><span class="name">',k+=e(c.nameHide(a.user.username,"**")),k+='</span><span class="time">',k+=e(c.timeFormat(1e3*a.created_time)),k+="</span></p> "),k+=" "}),k+=" "),k+=" </div> </div> </div> "),k+=" ",d.introduction&&(k+=' <div class="content"> <div class="title"><span>兑换说明</span></div> <div class="article"> ',k+=e(d.introduction.replace(/\n/g,"<br>")),k+=" </div> </div> "),k+=" ",d.prize_introduction&&(k+=' <div class="content"> <div class="title"><span>产品介绍</span></div> <div class="introduction"> ',k+=e(d.prize_introduction),k+=" </div> </div> "),k+=" </div> ",d.sku_category&&(k+=' <div id="J_SkuPanel" class="sku-panel"> <ul> ',j(d.sku_category.split(";"),function(a,b){k+='<li class="sku"> <label for="J_Sku',k+=e(b),k+='"> <input id="J_Sku',k+=e(b),k+='" type="radio" name="sku_category" value="',k+=e(a),k+='"> <span>',k+=e(a),k+="</span> </label> </li>"}),k+=' </ul> <button class="btn close" id="J_SkuClose">关闭</button> </div> <div id="J_SkuMask" class="mask"></div> '),k+=" ",new String(k)})},{"../template":5}],5:[function(a,b,c){"use strict";!function(){function a(a,b){return(/string|function/.test(typeof b)?i:h)(a,b)}function c(a,b){return"string"!=typeof a&&(b=typeof a,"number"===b?a+="":a="function"===b?c(a.call(a)):""),a}function d(a){return m[a]}function e(a){return c(a).replace(/&(?![\w#]+;)|[<>"']/g,d)}function f(a,b){if(n(a))for(var c=0,d=a.length;d>c;c++)b.call(a,a[c],c,a);else for(c in a)b.call(a,a[c],c)}function g(a,b){var c=/(\/)[^\/]+\1\.\.\1/,d=("./"+a).replace(/[^\/]+$/,""),e=d+b;for(e=e.replace(/\/\.\//g,"/");e.match(c);)e=e.replace(c,"/");return e}function h(b,c){var d=a.get(b)||j({filename:b,name:"Render Error",message:"Template not found"});return c?d(c):d}function i(a,b){if("string"==typeof b){var c=b;b=function(){return new l(c)}}var d=k[a]=function(c){try{return new b(c,a)+""}catch(d){return j(d)()}};return d.prototype=b.prototype=o,d.toString=function(){return b+""},d}function j(a){var b="{Template Error}",c=a.stack||"";if(c)c=c.split("\n").slice(0,2).join("\n");else for(var d in a)c+="<"+d+">\n"+a[d]+"\n\n";return function(){return"object"==typeof console&&console.error(b+"\n\n"+c),b}}var k=a.cache={},l=window.String,m={"<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","&":"&#38;"},n=Array.isArray||function(a){return"[object Array]"==={}.toString.call(a)},o=a.utils={$helpers:{},$include:function(a,b,c){return a=g(c,a),h(a,b)},$string:c,$escape:e,$each:f},p=a.helpers=o.$helpers;a.get=function(a){return k[a.replace(/^\.\//,"")]},a.helper=function(a,b){p[a]=b},b.exports=a}()},{}],6:[function(a,b,c){"use strict";var d={elem:".J_Loading",onshow:function(){},onhide:function(){}},e='<div class="J_Loading loading"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>',f=function(a){var b=null;a=$.extend(d,a||{}),$.extend(this,a),b=$(a.elem),0===b.length&&(b=$(e),document.body.appendChild(b[0])),this.$elem=b},g=f.prototype={constructor:f};$.extend(g,{show:function(){return this.$elem.show(),this.__dispatchEvent("show"),this},hide:function(){return this.$elem.hide(),this.__dispatchEvent("hide"),this},__dispatchEvent:function(a,b){this["on"+a]&&this["on"+a](b)},destory:function(){this.$elem.remove();for(var a in this)delete this[a];return this}}),b.exports=f},{}],7:[function(a,b,c){"use strict";function d(a,b){for(var c in b)a=a.replace(new RegExp("\\{"+c+"\\}","g"),b[c]);return a}var e={delay:0,loading:!1,content:"",fixed:!0,mask:!0,duration:.5,align:"center",onshow:function(){},onclose:function(){}},f='<div class="my-toast">{loading}<div class="inner">{content}</div></div>',g='<div class="loading"></div>',h=function j(a){a=$.extend({},e,a||{}),$.extend(this,a);var b=d(f,{content:this.content,loading:this.loading?g:""}),c=this.zIndex||j.zIndex,h=this.$elem=$(b).css({display:"none",position:"absolute",boxSizing:"border-box",minWidth:"6.25rem",padding:"1rem",borderRadius:".625rem",backgroundColor:"rgba(0, 0, 0, .75)",fontSize:"1rem",color:"white",zIndex:c,opacity:0,textAlign:this.align,transition:"opacity "+this.duration+"s ease-out"}).attr("tabindex","-1").appendTo("body");this.$mask=$("<div />").css({display:"none",position:"fixed",left:0,top:0,bottom:0,right:0,width:"100%",height:"100%",userSelect:"none",zIndex:c-1,backgroundColor:"rgba(0, 0, 0, 0)"}).insertAfter(h[0]),this.$content=h.find(".inner")},i=h.prototype={constructor:h};$.extend(i,{show:function(){var a=this,b=this.$elem;b.css("position",this.fixed?"fixed":"absolute"),this.mask&&this.$mask.show(),b.show().css({opacity:1}),this.reset(),this.__dispatchEvent("show");var c=this.delay;return c&&"number"==typeof c&&setTimeout(function(){a.close().remove()},1e3*c),this},close:function(){return this.$elem.hide(),this.$mask.hide(),this},remove:function(){this.$elem.remove(),this.$mask.remove();for(var a in this)delete this[a];return this},reset:function(){var a=this.$elem,b=$(window),c=this.fixed,d=c?0:b.scrollLeft(),e=c?0:b.scrollTop(),f=b.width(),g=b.height(),h=a.width(),i=a.height(),j=(f-h)/2+d,k=382*(g-i)/1e3+e,l=a[0].style;return l.left=Math.max(parseInt(j),d)+"px",l.top=Math.max(parseInt(k),e)+"px",this},__dispatchEvent:function(a,b){this["on"+a]&&this["on"+a](b)}}),h.zIndex=99,b.exports=h},{}]},{},[3]);